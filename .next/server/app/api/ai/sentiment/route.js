(()=>{var e={};e.id=206,e.ids=[206],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:e=>{"use strict";e.exports=import("pg")},80441:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{patchFetch:()=>c,routeModule:()=>l,serverHooks:()=>m,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>d});var n=r(42706),a=r(28203),o=r(45994),i=r(56432),u=e([i]);i=(u.then?(await u)():u)[0];let l=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/ai/sentiment/route",pathname:"/api/ai/sentiment",filename:"route",bundlePath:"app/api/ai/sentiment/route"},resolvedPagePath:"/Volumes/Extreme SSD/Aro Desk/app/api/ai/sentiment/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:p,workUnitAsyncStorage:d,serverHooks:m}=l;function c(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:d})}s()}catch(e){s(e)}})},96487:()=>{},78335:()=>{},56432:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>u});var n=r(39187),a=r(44481),o=r(62545),i=e([o]);async function u(e){try{let t=process.env.N8N_WEBHOOK_API_KEY,r=e.headers.get("x-api-key")||"";if(!t||r!==t)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{account_id:s,items:i}=await e.json();if(!s||!Array.isArray(i))return n.NextResponse.json({error:"Invalid payload"},{status:400});let u=[];for(let e of i){let t=await (0,a.G)(e.text),r=t.label||(t.score<-.2?"negative":t.score>.2?"positive":"neutral"),n=`
        INSERT INTO sentiment_analyses (tenant_id, account_id, source_type, source_id, sentiment_score, magnitude, label, summary, language)
        VALUES (current_tenant_id(), $1, $2, $3, $4, $5, $6, $7, $8)
        ON CONFLICT (tenant_id, source_type, source_id)
        DO UPDATE SET sentiment_score = EXCLUDED.sentiment_score, magnitude = EXCLUDED.magnitude, label = EXCLUDED.label, summary = EXCLUDED.summary
        RETURNING id
      `,i=await (0,o.P)(n,[s,e.source_type,e.source_id,t.score,t.magnitude||null,r,t.summary||null,e.language||t.language||"en"]);u.push({id:i.rows[0].id,label:r,score:t.score})}return n.NextResponse.json({ok:!0,results:u})}catch(e){return n.NextResponse.json({error:e.message||"Server error"},{status:500})}}o=(i.then?(await i)():i)[0],s()}catch(e){s(e)}})},44481:(e,t,r)=>{"use strict";async function s(e,t){let r=process.env.OPENAI_API_KEY;if(!r)throw Error("OPENAI_API_KEY is not set");let s={model:process.env.OPENAI_MODEL||"gpt-4.1-mini",messages:[t?{role:"system",content:t}:void 0,{role:"user",content:e}].filter(Boolean),temperature:.2},n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(s)});if(!n.ok){let e=await n.text();throw Error(`OpenAI error: ${n.status} ${e}`)}return await n.json()}async function n(e){let t=`Text:
${e}

Return strict JSON.`,r=await s(t,"You analyze customer success text for sentiment. Return JSON with keys: score (-1..1), magnitude (0..inf), label (negative|neutral|positive), summary, language."),n=r.choices?.[0]?.message?.content||"{}";try{return JSON.parse(n)}catch{return{score:0,label:"neutral",summary:"Unable to parse",language:"en"}}}async function a(e){let t=`Context: ${JSON.stringify(e)}

Write the email body only.`,r=await s(t,"You are a Customer Success assistant. Write concise, friendly follow-up emails that are actionable.");return r.choices?.[0]?.message?.content||""}r.d(t,{G:()=>n,g:()=>a})},62545:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{Fh:()=>u,KU:()=>i,P:()=>o});var n=r(64939),a=e([n]);let c=new(n=(a.then?(await a)():a)[0]).Pool({connectionString:process.env.DATABASE_URL,max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});async function o(e,t){let r=Date.now();try{let s=await c.query(e,t),n=Date.now()-r;return console.log("Executed query",{text:e,duration:n,rows:s.rowCount}),s}catch(e){throw console.error("Database query error:",e),e}}async function i(){return c.connect()}async function u(e,t){let r=`SET LOCAL app.current_user_id = '${e}'`;t?await t.query(r):await o(r)}s()}catch(e){s(e)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,452],()=>r(80441));module.exports=s})();