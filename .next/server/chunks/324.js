"use strict";exports.id=324,exports.ids=[324],exports.modules={4119:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{"00144cf6654d6ec1e8cd64cbed3894d48e549ec871":()=>e.VM,"0015914090221b6ca84d14e1308b196dc4b8e6f0f1":()=>h.Y2,"003583416e87b251e33ce882594462a66d58ec43c9":()=>g.Q1,"0035f80d577deaf627a2535a76284d8300e80aef06":()=>g.HB,"0040b0b31607f3dc9b068414fc93e23f911d80cca6":()=>f.CF,"006ffebcc94bd590a30dc9eba8d78bce7f67358af1":()=>e.Ht,"008abfb41bc0e4059c480ca878b9b296686bb9e769":()=>f.Dg,"00a044c99037ffb9b85a4ca9b34ff06c3184309895":()=>f.xR,"00a5edfe0611a70d8b2537b4000066af189747e8fd":()=>f.jm,"00dd6164ca3750410eeab95c47d13d1c31d06a5f65":()=>e.Kd,"00f9bf7ebb524526964cc9b40c980564aa908a7931":()=>g.mf,"400754bc52311390ac22d9ee449ca23223e7f3485f":()=>g.xP,"400cab6810f0812f6a3e3cbe0185411af4a6108f12":()=>f.kg,"40217e706d115e71fe47e55e38850493534551a810":()=>h.Rc,"4032e617fa50a4046b330fb49f493bf832839b26e2":()=>g.qO,"40342cf5aec6f70e3c659370cf748d68a15cc0caa4":()=>f.SC,"4034308342d3ee34b9fc47b548352fc320d974a722":()=>h.Ah,"404a2e09c20a4b2bafc95847a634b4922678932de2":()=>f.z5,"4058e4eedf37ad9ea7284e224195db07d6e76515ab":()=>g.P4,"405ad847e24f80c989823b88db7fc2c172197028d3":()=>f.So,"405e8e943fd33c6fab8c8d425b0d0c408126507924":()=>g.hd,"40815dd342be4b2a2672e687cbbc8e04352b1cdae8":()=>f.cB,"40880c5c97236d745490c2dfdc64edb9096b9468f3":()=>e.Lz,"408db9863caa72095816bcf1823bb20278b92b49f6":()=>g.ND,"40b0704a9b0fe78e21bfbfb1380e804abea90646e7":()=>e.zP,"40b47581fc530998e25dcc421676246ec1d6989086":()=>f.hG,"40cc5f5ee0050487b8e092fc7239b9104a3ea934bf":()=>g.yW,"40cd7b2b3cacb9264c695a38d1f31097064af56183":()=>g.Ao,"40d082e2f235ea4ba7ebb0544b77b0c34f5a65e2e1":()=>e.RX,"40d851cb6a26ab04adc2b35b3947d3159ce4b6321b":()=>g._m,"40dbc31e48d3a66925c1be4c4979c6d802606b8f66":()=>f.SM,"40df15242f885ada9a1dd36a28fad40cf403326729":()=>g.sU,"40ea5784e4c1d5813253a9d80a3dc2d2a9852e3801":()=>h.fh,"40fb7f43c90d9a15fcbafae1db5f41b8af44556765":()=>f.hT,"40fc687fc268beaf70156c41a51322256b9b415907":()=>g.lw,"600a957482d07b8d7d15f51c269221c9909f347e06":()=>h.pv,"601c12054569ec058b222570ae5efcbab51c5e26e1":()=>f.WA,"6037ad7dc08be9d3b23640fe2d518172c0776d10d1":()=>h.om,"604020a76fe5432caca839380f0eedba5bf049093c":()=>h._J,"60415273200a8d3b393ed1548e39f14c20078759d5":()=>f.e9,"6054ff2be65ee86c1e92c6cc11f4699acf4a4ed250":()=>h.ZC,"606464398d6c78737b48e03e15fd53a8951d82e454":()=>h.MM,"6065effde9eccc9fa6fe076b2b98b7a7f3c7896764":()=>h.D4,"60719ae6b70627535706da6a92e331e789cee7628a":()=>h.yS,"6083b1acefccb0e482642ea7385093b6f01a98440e":()=>f.GF,"609a24f87fee4b3ca559ad1c21f64534d1838f6e4a":()=>g.o2,"60b0a236d0750ca38acab7678add25d129c56605bf":()=>h.i2,"60d55d8d7f519f8bf579f7d500249634d64f74d98f":()=>h.q2,"60ec41137af5e7a75705fef719b2e466548c844d69":()=>g.z0,"60fd647de0b2ca0a1b2ec428ebe2f1092bcee3e3e0":()=>h.h,"703db55d8e9ab06297d80d9d40ace5850c3035fcdd":()=>h.jZ,"70b54de73cc768597933a251865628f27c19fddd19":()=>g.N9,"70c9624f4ddd383e290e219a6684840e6c6703e36f":()=>h.FW,"70ffa2ef0b1b9f333c8bd08c1ba2940e506a4ba926":()=>f.v_,"7800c180504809383bf814c85f736c3c26b7e934b6":()=>h.Xy,"787d42cddfdbcf595fa67ce93a676cc8eeb10065ef":()=>h.C5,"789f4adf4ff72d4c4cfa96e2ead1fbfa072322071a":()=>h.Vi,"7c06fc947652174db0c6312135c684969b07862fae":()=>h.Hu,"7e862cc42b0ff24892e7669c129eef53e0cc2c2b09":()=>h.GG});var e=c(32109),f=c(31258),g=c(18261),h=c(59737),i=a([e,f,g,h]);[e,f,g,h]=i.then?(await i)():i,d()}catch(a){d(a)}})},22821:(a,b,c)=>{c.d(b,{BT:()=>j,Wu:()=>k,ZB:()=>i,Zp:()=>g,aR:()=>h});var d=c(75338),e=c(74515),f=c(95012);let g=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{ref:c,className:(0,f.cn)("rounded-xl border bg-card text-card-foreground shadow",a),...b}));g.displayName="Card";let h=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{ref:c,className:(0,f.cn)("flex flex-col space-y-1.5 p-6",a),...b}));h.displayName="CardHeader";let i=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("h3",{ref:c,className:(0,f.cn)("font-semibold leading-none tracking-tight",a),...b}));i.displayName="CardTitle";let j=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("p",{ref:c,className:(0,f.cn)("text-sm text-muted-foreground",a),...b}));j.displayName="CardDescription";let k=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{ref:c,className:(0,f.cn)("p-6 pt-0",a),...b}));k.displayName="CardContent",e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{ref:c,className:(0,f.cn)("flex items-center p-6 pt-0",a),...b})).displayName="CardFooter"},35579:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(4290).A)("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]])},37762:(a,b,c)=>{c.d(b,{E:()=>h});var d=c(75338);c(74515);var e=c(86281),f=c(95012);let g=(0,e.F)("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function h({className:a,variant:b,...c}){return(0,d.jsx)("div",{className:(0,f.cn)(g({variant:b}),a),...c})}},59737:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Ah:()=>x,C5:()=>t,D4:()=>F,FW:()=>w,GG:()=>m,Hu:()=>v,MM:()=>A,Rc:()=>y,Vi:()=>r,Xy:()=>q,Y2:()=>E,ZC:()=>l,_J:()=>z,fh:()=>D,h:()=>p,i2:()=>n,jZ:()=>u,om:()=>o,pv:()=>s,q2:()=>B,yS:()=>C});var e=c(75879);c(68633);var f=c(27143),g=c(89443),h=c(32109),i=c(16780),j=c(51669),k=a([f,h]);async function l(a,b){let c=`
    INSERT INTO lifecycle_stages (tenant_id, name, weights)
    VALUES (current_tenant_id(), $1, $2::jsonb)
    ON CONFLICT (tenant_id, name)
    DO UPDATE SET weights = EXCLUDED.weights, updated_at = NOW()
    RETURNING id, name, weights
  `;return(await (0,f.P)(c,[a,JSON.stringify(b)])).rows[0]}async function m(a,b,c,d,e,g){let h=await (0,f.P)("SELECT weights FROM lifecycle_stages WHERE tenant_id = current_tenant_id() AND name = $1 AND is_active = true",[b]),i=h.rows[0]?.weights||{usage_frequency:.4,breadth:.3,depth:.3},j=Number(c.usage_frequency||0),k=Number(c.breadth||0),l=Number(c.depth||0),m=j*Number(i.usage_frequency||0)+k*Number(i.breadth||0)+l*Number(i.depth||0),n=await (0,f.P)("SELECT overall_score FROM health_scores WHERE tenant_id = current_tenant_id() AND account_id = $1 ORDER BY calculated_at DESC LIMIT 1",[a]),o=n.rows[0]?Number(m)-Number(n.rows[0].overall_score||0):null,p=`
    INSERT INTO health_scores (tenant_id, account_id, stage, score, metrics, window_start, window_end, trend, notes)
    VALUES (current_tenant_id(), $1, $2, $3, $4::jsonb, $5, $6, $7, $8)
    RETURNING id, score, trend
  `,q=await (0,f.P)(p,[a,b,m,JSON.stringify(c),d,e,o,g||null]);return null!==o&&o<-.1&&await (0,f.P)("INSERT INTO alerts (tenant_id, account_id, alert_type, severity, message, context) VALUES (current_tenant_id(), $1, $2, $3, $4, $5::jsonb)",[a,"health_dip","warning","Health score decreased",JSON.stringify({stage:b,score:m,trend:o})]),q.rows[0]}async function n(a,b=12){return(await (0,f.P)(`SELECT 
       calculated_at AS window_end,
       overall_score AS score,
       score_change AS trend,
       risk_level AS stage
     FROM health_scores
     WHERE tenant_id = current_tenant_id() AND account_id = $1
     ORDER BY calculated_at DESC
     LIMIT $2`,[a,b])).rows}async function o(a,b=12){return(await (0,f.P)(`SELECT
       calculated_at AS window_end,
       usage_score,
       engagement_score,
       support_sentiment_score,
       adoption_score
     FROM health_scores
     WHERE tenant_id = current_tenant_id() AND account_id = $1
     ORDER BY calculated_at DESC
     LIMIT $2`,[a,b])).rows}async function p(a,b){let c=[];for(let d of b){let b=await (0,g.G)(d.text),e=b.label||(b.score<-.2?"negative":b.score>.2?"positive":"neutral"),h=`
      INSERT INTO sentiment_analyses (tenant_id, account_id, source_type, source_id, sentiment_score, magnitude, label, summary, language)
      VALUES (current_tenant_id(), $1, $2, $3, $4, $5, $6, $7, $8)
      ON CONFLICT (tenant_id, source_type, source_id)
      DO UPDATE SET sentiment_score = EXCLUDED.sentiment_score, magnitude = EXCLUDED.magnitude, label = EXCLUDED.label, summary = EXCLUDED.summary
      RETURNING id
    `,i=await (0,f.P)(h,[a,d.source_type,d.source_id,b.score,b.magnitude||null,e,b.summary||null,d.language||b.language||"en"]);c.push({id:i.rows[0].id,label:e,score:b.score}),b.score<-.4&&await (0,f.P)("INSERT INTO alerts (tenant_id, account_id, alert_type, severity, message, context) VALUES (current_tenant_id(), $1, $2, $3, $4, $5::jsonb)",[a,"sentiment_negative","warning","Negative sentiment detected",JSON.stringify({source_type:d.source_type,source_id:d.source_id,score:b.score})])}return c}async function q(a,b,c,d){return(await (0,f.P)("INSERT INTO success_plans (tenant_id, account_id, name, target_date, attributes) VALUES (current_tenant_id(), $1, $2, $3, $4::jsonb) RETURNING id",[a,b,c||null,JSON.stringify(d||{})])).rows[0]}async function r(a,b,c,d){return(await (0,f.P)("INSERT INTO success_plan_steps (tenant_id, plan_id, title, due_date, assignee_user_id) VALUES (current_tenant_id(), $1, $2, $3, $4) RETURNING id",[a,b,c||null,d||null])).rows[0]}async function s(a,b){return await (0,f.P)("UPDATE success_plan_steps SET status = $1, updated_at = NOW() WHERE id = $2 AND tenant_id = current_tenant_id()",[b,a]),{ok:!0}}async function t(a,b,c,d){let e=await (0,h.Ht)();if(!e)throw Error("Unauthorized");let g=await (0,f.KU)();try{await g.query("BEGIN"),await (0,f.Fh)(e.userId,g);let h=await g.query("SELECT tenant_id FROM profiles WHERE id = $1",[e.userId]),j=h.rows[0]?.tenant_id;if(!j)throw Error("Unable to resolve tenant for current user");let k=a.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"")+"_"+Date.now(),l=c?.type||"manual",m=c?.params||{},n=c?.webhook_url||"https://example.com/webhook/placeholder",o=await g.query(`INSERT INTO playbooks (
        tenant_id, name, description, 
        trigger_type, trigger_criteria, webhook_url, 
        scenario_key, triggers, actions
      ) 
       VALUES ($1, $2, $3, $4, $5::jsonb, $6, $7, $8::jsonb, $9::jsonb) 
       RETURNING id`,[j,a,b,{health_score_drop:"Health Score Drop",stage_change:"Stage Transition",usage_decline:"Usage Decline",support_spike:"Support Ticket",contract_approaching:"Contract Expiration",manual:"Manual",scheduled:"Scheduled"}[l]||"Manual",JSON.stringify(m),n,k,JSON.stringify(c),JSON.stringify(d)]);return await g.query("COMMIT"),(0,i.revalidatePath)("/dashboard/automation"),{success:!0,id:o.rows[0].id}}catch(a){throw await g.query("ROLLBACK"),console.error("Error creating playbook:",a),a}finally{g.release()}}async function u(a,b,c="system"){let d=await (0,f.P)("SELECT actions FROM playbooks WHERE id = $1 AND tenant_id = current_tenant_id() AND is_active = true",[a]);if(!d.rows[0])return{error:"Playbook not found or inactive"};let e=d.rows[0].actions;return{id:(await (0,f.P)("INSERT INTO playbook_runs (tenant_id, playbook_id, account_id, status, triggered_by, result) VALUES (current_tenant_id(), $1, $2, $3, $4, $5::jsonb) RETURNING id",[a,b,"completed",c,JSON.stringify({actions_executed:e})])).rows[0].id,actions:e}}async function v(a,b,c,d,e){return await (0,f.P)("INSERT INTO cdi_events (tenant_id, account_id, source_type, event_type, payload, occurred_at) VALUES (current_tenant_id(), $1, $2, $3, $4::jsonb, $5)",[a,b,c,JSON.stringify(d),e]),{ok:!0}}async function w(a,b,c){let d=await (0,g.g)(c);return{id:(await (0,f.P)("INSERT INTO ai_workflow_runs (tenant_id, workflow_id, account_id, input, output, status, started_at, completed_at) VALUES (current_tenant_id(), $1, $2, $3::jsonb, $4::jsonb, $5, NOW(), NOW()) RETURNING id",[a,b,JSON.stringify(c),JSON.stringify({email_body:d}),"completed"])).rows[0].id,email_body:d}}async function x(a){return(await (0,f.P)("SELECT * FROM success_plans WHERE tenant_id = current_tenant_id() AND account_id = $1 ORDER BY created_at DESC",[a])).rows}async function y(a){return(await (0,f.P)("SELECT * FROM success_plan_steps WHERE tenant_id = current_tenant_id() AND plan_id = $1 ORDER BY sort_order, created_at",[a])).rows}async function z(a,b=20){return(await (0,f.P)("SELECT * FROM alerts WHERE tenant_id = current_tenant_id() AND account_id = $1 ORDER BY created_at DESC LIMIT $2",[a,b])).rows}async function A(a,b=50){return(await (0,f.P)("SELECT * FROM sentiment_analyses WHERE tenant_id = current_tenant_id() AND account_id = $1 ORDER BY created_at DESC LIMIT $2",[a,b])).rows}async function B(a,b=50){return(await (0,f.P)("SELECT * FROM cdi_events WHERE tenant_id = current_tenant_id() AND account_id = $1 ORDER BY occurred_at DESC LIMIT $2",[a,b])).rows}async function C(a,b=20){return(await (0,f.P)("SELECT pr.*, pb.name AS playbook_name FROM playbook_runs pr LEFT JOIN playbooks pb ON pr.playbook_id = pb.id WHERE pr.tenant_id = current_tenant_id() AND pr.account_id = $1 ORDER BY pr.created_at DESC LIMIT $2",[a,b])).rows}async function D(a=20){return(await (0,f.P)("SELECT e.*, a.name AS account_name FROM cdi_events e LEFT JOIN accounts a ON e.account_id = a.id WHERE e.tenant_id = current_tenant_id() ORDER BY e.occurred_at DESC LIMIT $1",[a])).rows}async function E(){let a=await (0,f.P)("SELECT id FROM ai_workflows WHERE tenant_id = current_tenant_id() AND is_active = true ORDER BY updated_at DESC LIMIT 1");return a.rows[0]?.id||null}async function F(a,b){let c=await E();return c?w(c,a,b):{error:"No active AI workflow configured"}}[f,h]=k.then?(await k)():k,(0,j.D)([l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F]),(0,e.A)(l,"6054ff2be65ee86c1e92c6cc11f4699acf4a4ed250",null),(0,e.A)(m,"7e862cc42b0ff24892e7669c129eef53e0cc2c2b09",null),(0,e.A)(n,"60b0a236d0750ca38acab7678add25d129c56605bf",null),(0,e.A)(o,"6037ad7dc08be9d3b23640fe2d518172c0776d10d1",null),(0,e.A)(p,"60fd647de0b2ca0a1b2ec428ebe2f1092bcee3e3e0",null),(0,e.A)(q,"7800c180504809383bf814c85f736c3c26b7e934b6",null),(0,e.A)(r,"789f4adf4ff72d4c4cfa96e2ead1fbfa072322071a",null),(0,e.A)(s,"600a957482d07b8d7d15f51c269221c9909f347e06",null),(0,e.A)(t,"787d42cddfdbcf595fa67ce93a676cc8eeb10065ef",null),(0,e.A)(u,"703db55d8e9ab06297d80d9d40ace5850c3035fcdd",null),(0,e.A)(v,"7c06fc947652174db0c6312135c684969b07862fae",null),(0,e.A)(w,"70c9624f4ddd383e290e219a6684840e6c6703e36f",null),(0,e.A)(x,"4034308342d3ee34b9fc47b548352fc320d974a722",null),(0,e.A)(y,"40217e706d115e71fe47e55e38850493534551a810",null),(0,e.A)(z,"604020a76fe5432caca839380f0eedba5bf049093c",null),(0,e.A)(A,"606464398d6c78737b48e03e15fd53a8951d82e454",null),(0,e.A)(B,"60d55d8d7f519f8bf579f7d500249634d64f74d98f",null),(0,e.A)(C,"60719ae6b70627535706da6a92e331e789cee7628a",null),(0,e.A)(D,"40ea5784e4c1d5813253a9d80a3dc2d2a9852e3801",null),(0,e.A)(E,"0015914090221b6ca84d14e1308b196dc4b8e6f0f1",null),(0,e.A)(F,"6065effde9eccc9fa6fe076b2b98b7a7f3c7896764",null),d()}catch(a){d(a)}})},89443:(a,b,c)=>{async function d(a,b){let c=process.env.OPENAI_API_KEY;if(!c)throw Error("OPENAI_API_KEY is not set");let d={model:process.env.OPENAI_MODEL||"gpt-4.1-mini",messages:[b?{role:"system",content:b}:void 0,{role:"user",content:a}].filter(Boolean),temperature:.2},e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(d)});if(!e.ok){let a=await e.text();throw Error(`OpenAI error: ${e.status} ${a}`)}return await e.json()}async function e(a){let b=`Text:
${a}

Return strict JSON.`,c=await d(b,"You analyze customer success text for sentiment. Return JSON with keys: score (-1..1), magnitude (0..inf), label (negative|neutral|positive), summary, language."),e=c.choices?.[0]?.message?.content||"{}";try{return JSON.parse(e)}catch{return{score:0,label:"neutral",summary:"Unable to parse",language:"en"}}}async function f(a){let b=`Context: ${JSON.stringify(a)}

Write the email body only.`,c=await d(b,"You are a Customer Success assistant. Write concise, friendly follow-up emails that are actionable.");return c.choices?.[0]?.message?.content||""}c.d(b,{G:()=>e,g:()=>f})},95012:(a,b,c)=>{c.d(b,{cn:()=>f});var d=c(81171),e=c(11167);function f(...a){return(0,e.QP)((0,d.$)(a))}}};