exports.id=662,exports.ids=[662],exports.modules={16953:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>h,metadata:()=>g});var d=c(75338),e=c(42003),f=c.n(e);c(82704);let g={title:"Customer Success Platform",description:"Multi-tenant Customer Success Platform with RLS"};function h({children:a}){return(0,d.jsx)("html",{lang:"en",children:(0,d.jsx)("body",{className:f().className,children:a})})}},27143:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{Fh:()=>i,KU:()=>h,P:()=>g});var e=c(64939),f=a([e]);let j=new(e=(f.then?(await f)():f)[0]).Pool({connectionString:process.env.DATABASE_URL,max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});async function g(a,b){let c=Date.now();try{let d=await j.query(a,b),e=Date.now()-c;return console.log("Executed query",{text:a,duration:e,rows:d.rowCount}),d}catch(a){throw console.error("Database query error:",a),a}}async function h(){return j.connect()}async function i(a,b){let c=`SET LOCAL app.current_user_id = '${a}'`;b?await b.query(c):await g(c)}d()}catch(a){d(a)}})},31258:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{CF:()=>o,Dg:()=>p,GF:()=>B,SC:()=>w,SM:()=>y,So:()=>A,WA:()=>s,cB:()=>C,e9:()=>u,hG:()=>t,hT:()=>v,jm:()=>n,kg:()=>q,v_:()=>r,xR:()=>x,z5:()=>z});var e=c(75879);c(68633);var f=c(27143),g=c(32109),h=c(82161),i=c(16780),j=c(87082),k=c.n(j),l=c(51669),m=a([f,g]);async function n(){let a=await (0,g.Ht)();if(!a)return!1;let b=await (0,f.KU)();try{let c=await b.query("SELECT is_super_admin FROM profiles WHERE id = $1",[a.userId]);return c.rows.length>0&&!0===c.rows[0].is_super_admin}finally{b.release()}}async function o(){if(!await n())return{error:"Unauthorized: Super admin access required"};let a=await (0,f.KU)();try{return{users:(await a.query(`SELECT 
        u.id,
        u.email,
        u.created_at as user_created_at,
        p.full_name,
        p.role,
        p.is_active,
        p.is_super_admin,
        p.created_at as profile_created_at,
        t.name as tenant_name,
        t.slug as tenant_slug,
        t.id as tenant_id
       FROM users u
       JOIN profiles p ON u.id = p.id
       JOIN tenants t ON p.tenant_id = t.id
       ORDER BY u.created_at DESC`)).rows}}catch(a){return console.error("Get all users error:",a),{error:a.message||"Failed to fetch users"}}finally{a.release()}}async function p(){if(!await n())return{error:"Unauthorized: Super admin access required"};let a=await (0,f.KU)();try{return{tenants:(await a.query(`SELECT 
        id,
        name,
        slug,
        is_active,
        created_at,
        (SELECT COUNT(*) FROM profiles WHERE tenant_id = tenants.id) as user_count
       FROM tenants
       ORDER BY created_at DESC`)).rows}}catch(a){return console.error("Get all tenants error:",a),{error:a.message||"Failed to fetch tenants"}}finally{a.release()}}async function q(a){if(!await n())return{error:"Unauthorized: Super admin access required"};let b=await (0,f.KU)();try{if(await b.query("BEGIN"),(await b.query("SELECT id FROM users WHERE email = $1",[a.email])).rows.length>0)return await b.query("ROLLBACK"),{error:"User with this email already exists"};let c=await b.query("SELECT id FROM tenants WHERE id = $1",[a.tenantId]);if(0===c.rows.length)return await b.query("ROLLBACK"),{error:"Tenant not found"};let d=await k().hash(a.password,10),e=(await b.query(`INSERT INTO users (email, encrypted_password, email_confirmed_at)
       VALUES ($1, $2, NOW())
       RETURNING id`,[a.email,d])).rows[0].id;return await b.query(`INSERT INTO profiles (id, tenant_id, role, full_name, is_active, is_super_admin)
       VALUES ($1, $2, $3, $4, true, $5)`,[e,a.tenantId,a.role,a.fullName,a.isSuperAdmin||!1]),await b.query("COMMIT"),(0,i.revalidatePath)("/admin"),{success:!0,userId:e}}catch(a){return await b.query("ROLLBACK"),console.error("Create user error:",a),{error:a.message||"Failed to create user"}}finally{b.release()}}async function r(a,b,c){if(!await n())return{error:"Unauthorized: Super admin access required"};let d=await (0,f.KU)();try{return await d.query(`UPDATE profiles 
       SET role = $1, is_super_admin = $2, updated_at = NOW()
       WHERE id = $3`,[b,c||!1,a]),(0,i.revalidatePath)("/admin"),{success:!0}}catch(a){return console.error("Update user role error:",a),{error:a.message||"Failed to update user role"}}finally{d.release()}}async function s(a,b){if(!await n())return{error:"Unauthorized: Super admin access required"};let c=await (0,f.KU)();try{return await c.query("UPDATE profiles SET is_active = $1, updated_at = NOW() WHERE id = $2",[b,a]),(0,i.revalidatePath)("/admin"),{success:!0}}catch(a){return console.error("Toggle user active error:",a),{error:a.message||"Failed to update user status"}}finally{c.release()}}async function t(a){if(!await n())return{error:"Unauthorized: Super admin access required"};let b=await (0,f.KU)();try{return await b.query("BEGIN"),await b.query("DELETE FROM profiles WHERE id = $1",[a]),await b.query("DELETE FROM users WHERE id = $1",[a]),await b.query("COMMIT"),(0,i.revalidatePath)("/admin"),{success:!0}}catch(a){return await b.query("ROLLBACK"),console.error("Delete user error:",a),{error:a.message||"Failed to delete user"}}finally{b.release()}}async function u(a,b){let c=await (0,g.Ht)();c||(0,h.redirect)("/login");let d=await (0,f.KU)();try{await d.query("BEGIN"),await (0,f.Fh)(c.userId,d);let e=[],g=[a],h=1;return b.name&&(e.push(`display_name = $${++h}`),g.push(b.name)),void 0!==b.displayOrder&&(e.push(`display_order = $${++h}`),g.push(b.displayOrder)),void 0!==b.targetDurationDays&&(e.push(`target_duration_days = $${++h}`),g.push(b.targetDurationDays)),b.colorHex&&(e.push(`color_hex = $${++h}`),g.push(b.colorHex)),e.length>0&&await d.query(`UPDATE journey_stages SET ${e.join(", ")} WHERE id = $1`,g),await d.query("COMMIT"),{success:!0}}catch(a){throw await d.query("ROLLBACK"),console.error("Error updating journey stage:",a),a}finally{d.release()}}async function v(a){let b=await (0,g.Ht)();b||(0,h.redirect)("/login");let c=await (0,f.KU)();try{await c.query("BEGIN"),await (0,f.Fh)(b.userId,c);let d=await c.query("SELECT tenant_id FROM profiles WHERE id = $1",[b.userId]),e=d.rows[0]?.tenant_id;if(!e)throw Error("Unable to resolve tenant for current user");let g=await c.query(`INSERT INTO journey_stages (stage, display_name, display_order, target_duration_days, color_hex, tenant_id)
       VALUES ($1, $2, $3, $4, $5, $6)
       ON CONFLICT (tenant_id, stage)
       DO UPDATE SET
         display_name = EXCLUDED.display_name,
         target_duration_days = EXCLUDED.target_duration_days,
         color_hex = EXCLUDED.color_hex
       RETURNING *`,[a.name,a.name,a.displayOrder,a.targetDurationDays,a.colorHex,e]);return await c.query("COMMIT"),(0,i.revalidatePath)("/dashboard/admin"),g.rows[0]}catch(a){throw await c.query("ROLLBACK"),console.error("Error creating journey stage:",a),a}finally{c.release()}}async function w(a){let b=await (0,g.Ht)();b||(0,h.redirect)("/login");let c=await (0,f.KU)();try{await c.query("BEGIN"),await (0,f.Fh)(b.userId,c);let d=await c.query("SELECT stage FROM journey_stages WHERE id = $1",[a]);if(0===d.rows.length)throw Error("Stage not found");let e=d.rows[0].stage,g=await c.query(`SELECT COUNT(*) as count FROM (
        SELECT DISTINCT ON (account_id) account_id, to_stage
        FROM journey_history
        WHERE to_stage = $1
        ORDER BY account_id, entered_at DESC
      ) latest_stages
      WHERE latest_stages.to_stage = $1`,[e]);if(parseInt(g.rows[0].count)>0)throw Error("Cannot delete stage that has active accounts");return await c.query("DELETE FROM journey_stages WHERE id = $1",[a]),await c.query("COMMIT"),{success:!0}}catch(a){throw await c.query("ROLLBACK"),console.error("Error deleting journey stage:",a),a}finally{c.release()}}async function x(){let a=await (0,g.Ht)();a||(0,h.redirect)("/login"),await (0,f.Fh)(a.userId);let b=await (0,f.P)(`SELECT usage_weight, engagement_weight, support_weight, adoption_weight 
     FROM health_scores 
     WHERE tenant_id = (SELECT tenant_id FROM profiles WHERE id = $1)
     ORDER BY calculated_at DESC 
     LIMIT 1`,[a.userId]);return 0===b.rows.length?{usage_weight:.35,engagement_weight:.25,support_weight:.2,adoption_weight:.2}:b.rows[0]}async function y(a){let b=await (0,g.Ht)();b||(0,h.redirect)("/login"),await (0,f.Fh)(b.userId);let c=a.usageWeight+a.engagementWeight+a.supportWeight+a.adoptionWeight;if(Math.abs(c-1)>.01)throw Error("Weights must sum to 1.0");return{success:!0,message:"Weights validated. These will be used for future health score calculations.",weights:{usage_weight:a.usageWeight,engagement_weight:a.engagementWeight,support_weight:a.supportWeight,adoption_weight:a.adoptionWeight}}}async function z(a){let b=await (0,g.Ht)();b||(0,h.redirect)("/login");let c=await (0,f.KU)();try{await c.query("BEGIN"),await (0,f.Fh)(b.userId,c);let d=await c.query("SELECT tenant_id FROM profiles WHERE id = $1",[b.userId]),e=d.rows[0]?.tenant_id;if(!e)throw Error("Unable to resolve tenant for current user");let g=await c.query(`INSERT INTO stage_milestones (stage_id, tenant_id, name, description, "order")
       VALUES ($1, $2, $3, $4, $5)
       RETURNING *`,[a.stageId,e,a.name,a.description,a.order]);return await c.query("COMMIT"),g.rows[0]}catch(a){throw await c.query("ROLLBACK"),console.error("Create milestone error:",a),a}finally{c.release()}}async function A(a){let b=await (0,g.Ht)();b||(0,h.redirect)("/login");let c=await (0,f.KU)();try{await c.query("BEGIN"),await (0,f.Fh)(b.userId,c);let d=await c.query('SELECT * FROM stage_milestones WHERE stage_id = $1 ORDER BY "order"',[a]);return await c.query("COMMIT"),d.rows}catch(a){throw await c.query("ROLLBACK"),console.error("Get milestones error:",a),a}finally{c.release()}}async function B(a,b){let c=await (0,g.Ht)();c||(0,h.redirect)("/login");let d=await (0,f.KU)();try{await d.query("BEGIN"),await (0,f.Fh)(c.userId,d);let e=[],g=[a],h=1;return b.name&&(e.push(`name = $${++h}`),g.push(b.name)),b.description&&(e.push(`description = $${++h}`),g.push(b.description)),void 0!==b.order&&(e.push(`"order" = $${++h}`),g.push(b.order)),e.length>0&&await d.query(`UPDATE stage_milestones SET ${e.join(", ")}, updated_at = NOW() WHERE id = $1`,g),await d.query("COMMIT"),{success:!0}}catch(a){throw await d.query("ROLLBACK"),console.error("Update milestone error:",a),a}finally{d.release()}}async function C(a){let b=await (0,g.Ht)();b||(0,h.redirect)("/login");let c=await (0,f.KU)();try{return await c.query("BEGIN"),await (0,f.Fh)(b.userId,c),await c.query("DELETE FROM stage_milestones WHERE id = $1",[a]),await c.query("COMMIT"),{success:!0}}catch(a){throw await c.query("ROLLBACK"),console.error("Delete milestone error:",a),a}finally{c.release()}}[f,g]=m.then?(await m)():m,(0,l.D)([n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C]),(0,e.A)(n,"00a5edfe0611a70d8b2537b4000066af189747e8fd",null),(0,e.A)(o,"0040b0b31607f3dc9b068414fc93e23f911d80cca6",null),(0,e.A)(p,"008abfb41bc0e4059c480ca878b9b296686bb9e769",null),(0,e.A)(q,"400cab6810f0812f6a3e3cbe0185411af4a6108f12",null),(0,e.A)(r,"70ffa2ef0b1b9f333c8bd08c1ba2940e506a4ba926",null),(0,e.A)(s,"601c12054569ec058b222570ae5efcbab51c5e26e1",null),(0,e.A)(t,"40b47581fc530998e25dcc421676246ec1d6989086",null),(0,e.A)(u,"60415273200a8d3b393ed1548e39f14c20078759d5",null),(0,e.A)(v,"40fb7f43c90d9a15fcbafae1db5f41b8af44556765",null),(0,e.A)(w,"40342cf5aec6f70e3c659370cf748d68a15cc0caa4",null),(0,e.A)(x,"00a044c99037ffb9b85a4ca9b34ff06c3184309895",null),(0,e.A)(y,"40dbc31e48d3a66925c1be4c4979c6d802606b8f66",null),(0,e.A)(z,"404a2e09c20a4b2bafc95847a634b4922678932de2",null),(0,e.A)(A,"405ad847e24f80c989823b88db7fc2c172197028d3",null),(0,e.A)(B,"6083b1acefccb0e482642ea7385093b6f01a98440e",null),(0,e.A)(C,"40815dd342be4b2a2672e687cbbc8e04352b1cdae8",null),d()}catch(a){d(a)}})},32109:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{Ht:()=>r,Kd:()=>u,Lz:()=>t,RX:()=>s,VM:()=>v,zP:()=>q});var e=c(75879);c(68633);var f=c(27143),g=c(86802),h=c(82161),i=c(16780),j=c(87082),k=c.n(j),l=c(42570),m=c(94069),n=c(51669),o=a([f]);f=(o.then?(await o)():o)[0];let w=new TextEncoder().encode(process.env.SESSION_SECRET||"local-dev-secret-change-in-production");async function p(a,b){return await new l.P({sub:a,email:b}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(w)}async function q(a){try{return(await (0,m.V)(a,w)).payload}catch(a){return null}}async function r(){let a=await (0,g.UL)(),b=a.get("session")?.value;if(!b)return null;let c=await q(b);if(!c)return null;let d=await (0,f.KU)();try{await d.query(`SET LOCAL app.current_user_id = '${c.sub}'`);let a=await d.query(`SELECT u.id, u.email, p.tenant_id, p.role, p.full_name, p.is_active
       FROM users u
       JOIN profiles p ON u.id = p.id
       WHERE u.id = $1`,[c.sub]);if(0===a.rows.length)return null;return{user:a.rows[0],userId:c.sub,email:c.email}}finally{d.release()}}async function s(a){let b=await (0,f.KU)();try{if(await b.query("BEGIN"),(await b.query("SELECT id FROM users WHERE email = $1",[a.email])).rows.length>0)return{error:"User with this email already exists"};let c=await k().hash(a.password,10),d=(await b.query(`INSERT INTO users (email, encrypted_password, email_confirmed_at)
       VALUES ($1, $2, NOW())
       RETURNING id`,[a.email,c])).rows[0].id,e=null;if(a.inviteToken)return{error:"Invite functionality not yet implemented"};let f=a.organizationName.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");e=(await b.query(`INSERT INTO tenants (name, slug, is_active)
       VALUES ($1, $2, true)
       RETURNING id`,[`${a.organizationName}`,`${f}-${Date.now()}`])).rows[0].id,await b.query(`INSERT INTO profiles (id, tenant_id, role, full_name, is_active)
       VALUES ($1, $2, $3, $4, true)`,[d,e,"Tenant Admin",a.fullName]),await b.query("COMMIT");let h=await p(d,a.email);return(await (0,g.UL)()).set("session",h,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),(0,i.revalidatePath)("/","layout"),{success:!0}}catch(a){return await b.query("ROLLBACK"),console.error("Signup error:",a),{error:a.message||"An unexpected error occurred during signup"}}finally{b.release()}}async function t(a){let b=await (0,f.KU)();try{let c=await b.query(`SELECT u.id, u.email, u.encrypted_password, p.tenant_id, p.role, p.is_active
       FROM users u
       JOIN profiles p ON u.id = p.id
       WHERE u.email = $1`,[a.email]);if(0===c.rows.length)return{error:"Invalid email or password"};let d=c.rows[0];if(!await k().compare(a.password,d.encrypted_password))return{error:"Invalid email or password"};if(!d.is_active)return{error:"Your account has been deactivated. Please contact your administrator."};let e=await p(d.id,d.email);return(await (0,g.UL)()).set("session",e,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),(0,i.revalidatePath)("/","layout"),{success:!0}}catch(a){return console.error("Signin error:",a),{error:"An unexpected error occurred during signin"}}finally{b.release()}}async function u(){(await (0,g.UL)()).delete("session"),(0,i.revalidatePath)("/","layout"),(0,h.redirect)("/login")}async function v(){let a=await r();if(!a)return null;let b=await (0,f.KU)();try{await b.query(`SET LOCAL app.current_user_id = '${a.userId}'`);let c=await b.query(`SELECT p.*, t.name as tenant_name, t.slug as tenant_slug
       FROM profiles p
       JOIN tenants t ON p.tenant_id = t.id
       WHERE p.id = $1`,[a.userId]);if(0===c.rows.length)return null;return{...c.rows[0],tenant:{id:c.rows[0].tenant_id,name:c.rows[0].tenant_name,slug:c.rows[0].tenant_slug}}}finally{b.release()}}(0,n.D)([q,r,s,t,u,v]),(0,e.A)(q,"40b0704a9b0fe78e21bfbfb1380e804abea90646e7",null),(0,e.A)(r,"006ffebcc94bd590a30dc9eba8d78bce7f67358af1",null),(0,e.A)(s,"40d082e2f235ea4ba7ebb0544b77b0c34f5a65e2e1",null),(0,e.A)(t,"40880c5c97236d745490c2dfdc64edb9096b9468f3",null),(0,e.A)(u,"00dd6164ca3750410eeab95c47d13d1c31d06a5f65",null),(0,e.A)(v,"00144cf6654d6ec1e8cd64cbed3894d48e549ec871",null),d()}catch(a){d(a)}})},52273:(a,b,c)=>{Promise.resolve().then(c.t.bind(c,54160,23)),Promise.resolve().then(c.t.bind(c,31603,23)),Promise.resolve().then(c.t.bind(c,68495,23)),Promise.resolve().then(c.t.bind(c,75170,23)),Promise.resolve().then(c.t.bind(c,77526,23)),Promise.resolve().then(c.t.bind(c,78922,23)),Promise.resolve().then(c.t.bind(c,29234,23)),Promise.resolve().then(c.t.bind(c,12263,23)),Promise.resolve().then(c.bind(c,82146))},62001:(a,b,c)=>{Promise.resolve().then(c.t.bind(c,81170,23)),Promise.resolve().then(c.t.bind(c,23597,23)),Promise.resolve().then(c.t.bind(c,36893,23)),Promise.resolve().then(c.t.bind(c,89748,23)),Promise.resolve().then(c.t.bind(c,6060,23)),Promise.resolve().then(c.t.bind(c,7184,23)),Promise.resolve().then(c.t.bind(c,69576,23)),Promise.resolve().then(c.t.bind(c,73041,23)),Promise.resolve().then(c.t.bind(c,51384,23))},78321:()=>{},78993:()=>{},82704:()=>{}};